import{aO as X,aH as ye,aP as He,aQ as we,aR as U,aS as Ce,aT as Ge,aU as Xe,aV as Ze,aW as Be,W as Ve,J as qe,S as We,K as Ke,L as $e,a6 as Qe,aX as Je,aY as et,a3 as tt,aN as nt,aZ as ot,a4 as z,a_ as C,a$ as G,aF as Ee,b0 as ve,aA as N,b1 as Ae,aL as Z,aK as xe,a8 as st}from"./vendor.89e4dd30.js";import it from"./wintersky.esm.27f144d8.js";var at=Object.defineProperty,rt=Object.defineProperties,lt=Object.getOwnPropertyDescriptors,Te=Object.getOwnPropertySymbols,ct=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable,Pe=(E,n,o)=>n in E?at(E,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):E[n]=o,ht=(E,n)=>{for(var o in n||(n={}))ct.call(n,o)&&Pe(E,o,n[o]);if(Te)for(var o of Te(n))ut.call(n,o)&&Pe(E,o,n[o]);return E},dt=(E,n)=>rt(E,lt(n));const Me={type:"change"},oe={type:"start"},_e={type:"end"};class pt extends ot{constructor(n,o){super();o===void 0&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),o===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=n,this.domElement=o,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new z,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:C.ROTATE,MIDDLE:C.DOLLY,RIGHT:C.PAN},this.touches={ONE:G.ROTATE,TWO:G.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",pe),this._domElementKeyEvents=t},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Me),e.update(),i=s.NONE},this.update=function(){const t=new z,r=new Ee().setFromUnitVectors(n.up,new z(0,1,0)),M=r.clone().invert(),_=new z,j=new Ee,H=2*Math.PI;return function(){const be=e.object.position;t.copy(be).sub(e.target),t.applyQuaternion(r),a.setFromVector3(t),e.autoRotate&&i===s.NONE&&b(g()),e.enableDamping?(a.theta+=l.theta*e.dampingFactor,a.phi+=l.phi*e.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let I=e.minAzimuthAngle,D=e.maxAzimuthAngle;return isFinite(I)&&isFinite(D)&&(I<-Math.PI?I+=H:I>Math.PI&&(I-=H),D<-Math.PI?D+=H:D>Math.PI&&(D-=H),I<=D?a.theta=Math.max(I,Math.min(D,a.theta)):a.theta=a.theta>(I+D)/2?Math.max(I,a.theta):Math.min(D,a.theta)),a.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,a.phi)),a.makeSafe(),a.radius*=c,a.radius=Math.max(e.minDistance,Math.min(e.maxDistance,a.radius)),e.enableDamping===!0?e.target.addScaledVector(h,e.dampingFactor):e.target.add(h),t.setFromSpherical(a),t.applyQuaternion(M),be.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(l.theta*=1-e.dampingFactor,l.phi*=1-e.dampingFactor,h.multiplyScalar(1-e.dampingFactor)):(l.set(0,0,0),h.set(0,0,0)),c=1,f||_.distanceToSquared(e.object.position)>p||8*(1-j.dot(e.object.quaternion))>p?(e.dispatchEvent(Me),_.copy(e.object.position),j.copy(e.object.quaternion),f=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",me),e.domElement.removeEventListener("pointerdown",ue),e.domElement.removeEventListener("pointercancel",he),e.domElement.removeEventListener("wheel",de),e.domElement.removeEventListener("pointermove",ee),e.domElement.removeEventListener("pointerup",te),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",pe)};const e=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=s.NONE;const p=1e-6,a=new ve,l=new ve;let c=1;const h=new z;let f=!1;const m=new N,d=new N,A=new N,v=new N,w=new N,x=new N,O=new N,T=new N,R=new N,u=[],k={};function g(){return 2*Math.PI/60/60*e.autoRotateSpeed}function y(){return Math.pow(.95,e.zoomSpeed)}function b(t){l.theta-=t}function P(t){l.phi-=t}const Y=function(){const t=new z;return function(M,_){t.setFromMatrixColumn(_,0),t.multiplyScalar(-M),h.add(t)}}(),F=function(){const t=new z;return function(M,_){e.screenSpacePanning===!0?t.setFromMatrixColumn(_,1):(t.setFromMatrixColumn(_,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(M),h.add(t)}}(),L=function(){const t=new z;return function(M,_){const j=e.domElement;if(e.object.isPerspectiveCamera){const H=e.object.position;t.copy(H).sub(e.target);let Q=t.length();Q*=Math.tan(e.object.fov/2*Math.PI/180),Y(2*M*Q/j.clientHeight,e.object.matrix),F(2*_*Q/j.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(Y(M*(e.object.right-e.object.left)/e.object.zoom/j.clientWidth,e.object.matrix),F(_*(e.object.top-e.object.bottom)/e.object.zoom/j.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function S(t){e.object.isPerspectiveCamera?c/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function B(t){e.object.isPerspectiveCamera?c*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function V(t){m.set(t.clientX,t.clientY)}function W(t){O.set(t.clientX,t.clientY)}function q(t){v.set(t.clientX,t.clientY)}function K(t){d.set(t.clientX,t.clientY),A.subVectors(d,m).multiplyScalar(e.rotateSpeed);const r=e.domElement;b(2*Math.PI*A.x/r.clientHeight),P(2*Math.PI*A.y/r.clientHeight),m.copy(d),e.update()}function $(t){T.set(t.clientX,t.clientY),R.subVectors(T,O),R.y>0?S(y()):R.y<0&&B(y()),O.copy(T),e.update()}function Re(t){w.set(t.clientX,t.clientY),x.subVectors(w,v).multiplyScalar(e.panSpeed),L(x.x,x.y),v.copy(w),e.update()}function ke(t){t.deltaY<0?B(y()):t.deltaY>0&&S(y()),e.update()}function Le(t){let r=!1;switch(t.code){case e.keys.UP:L(0,e.keyPanSpeed),r=!0;break;case e.keys.BOTTOM:L(0,-e.keyPanSpeed),r=!0;break;case e.keys.LEFT:L(e.keyPanSpeed,0),r=!0;break;case e.keys.RIGHT:L(-e.keyPanSpeed,0),r=!0;break}r&&(t.preventDefault(),e.update())}function se(){if(u.length===1)m.set(u[0].pageX,u[0].pageY);else{const t=.5*(u[0].pageX+u[1].pageX),r=.5*(u[0].pageY+u[1].pageY);m.set(t,r)}}function ie(){if(u.length===1)v.set(u[0].pageX,u[0].pageY);else{const t=.5*(u[0].pageX+u[1].pageX),r=.5*(u[0].pageY+u[1].pageY);v.set(t,r)}}function ae(){const t=u[0].pageX-u[1].pageX,r=u[0].pageY-u[1].pageY,M=Math.sqrt(t*t+r*r);O.set(0,M)}function Se(){e.enableZoom&&ae(),e.enablePan&&ie()}function je(){e.enableZoom&&ae(),e.enableRotate&&se()}function re(t){if(u.length==1)d.set(t.pageX,t.pageY);else{const M=ne(t),_=.5*(t.pageX+M.x),j=.5*(t.pageY+M.y);d.set(_,j)}A.subVectors(d,m).multiplyScalar(e.rotateSpeed);const r=e.domElement;b(2*Math.PI*A.x/r.clientHeight),P(2*Math.PI*A.y/r.clientHeight),m.copy(d)}function le(t){if(u.length===1)w.set(t.pageX,t.pageY);else{const r=ne(t),M=.5*(t.pageX+r.x),_=.5*(t.pageY+r.y);w.set(M,_)}x.subVectors(w,v).multiplyScalar(e.panSpeed),L(x.x,x.y),v.copy(w)}function ce(t){const r=ne(t),M=t.pageX-r.x,_=t.pageY-r.y,j=Math.sqrt(M*M+_*_);T.set(0,j),R.set(0,Math.pow(T.y/O.y,e.zoomSpeed)),S(R.y),O.copy(T)}function Ne(t){e.enableZoom&&ce(t),e.enablePan&&le(t)}function Ie(t){e.enableZoom&&ce(t),e.enableRotate&&re(t)}function ue(t){e.enabled!==!1&&(u.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",ee),e.domElement.addEventListener("pointerup",te)),Fe(t),t.pointerType==="touch"?ze(t):De(t))}function ee(t){e.enabled!==!1&&(t.pointerType==="touch"?Ue(t):Ye(t))}function te(t){fe(t),u.length===0&&(e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",ee),e.domElement.removeEventListener("pointerup",te)),e.dispatchEvent(_e),i=s.NONE}function he(t){fe(t)}function De(t){let r;switch(t.button){case 0:r=e.mouseButtons.LEFT;break;case 1:r=e.mouseButtons.MIDDLE;break;case 2:r=e.mouseButtons.RIGHT;break;default:r=-1}switch(r){case C.DOLLY:if(e.enableZoom===!1)return;W(t),i=s.DOLLY;break;case C.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;q(t),i=s.PAN}else{if(e.enableRotate===!1)return;V(t),i=s.ROTATE}break;case C.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;V(t),i=s.ROTATE}else{if(e.enablePan===!1)return;q(t),i=s.PAN}break;default:i=s.NONE}i!==s.NONE&&e.dispatchEvent(oe)}function Ye(t){if(e.enabled!==!1)switch(i){case s.ROTATE:if(e.enableRotate===!1)return;K(t);break;case s.DOLLY:if(e.enableZoom===!1)return;$(t);break;case s.PAN:if(e.enablePan===!1)return;Re(t);break}}function de(t){e.enabled===!1||e.enableZoom===!1||i!==s.NONE||(t.preventDefault(),e.dispatchEvent(oe),ke(t),e.dispatchEvent(_e))}function pe(t){e.enabled===!1||e.enablePan===!1||Le(t)}function ze(t){switch(ge(t),u.length){case 1:switch(e.touches.ONE){case G.ROTATE:if(e.enableRotate===!1)return;se(),i=s.TOUCH_ROTATE;break;case G.PAN:if(e.enablePan===!1)return;ie(),i=s.TOUCH_PAN;break;default:i=s.NONE}break;case 2:switch(e.touches.TWO){case G.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Se(),i=s.TOUCH_DOLLY_PAN;break;case G.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;je(),i=s.TOUCH_DOLLY_ROTATE;break;default:i=s.NONE}break;default:i=s.NONE}i!==s.NONE&&e.dispatchEvent(oe)}function Ue(t){switch(ge(t),i){case s.TOUCH_ROTATE:if(e.enableRotate===!1)return;re(t),e.update();break;case s.TOUCH_PAN:if(e.enablePan===!1)return;le(t),e.update();break;case s.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ne(t),e.update();break;case s.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ie(t),e.update();break;default:i=s.NONE}}function me(t){e.enabled!==!1&&t.preventDefault()}function Fe(t){u.push(t)}function fe(t){delete k[t.pointerId];for(let r=0;r<u.length;r++)if(u[r].pointerId==t.pointerId){u.splice(r,1);return}}function ge(t){let r=k[t.pointerId];r===void 0&&(r=new N,k[t.pointerId]=r),r.set(t.pageX,t.pageY)}function ne(t){const r=t.pointerId===u[0].pointerId?u[1]:u[0];return k[r.pointerId]}e.domElement.addEventListener("contextmenu",me),e.domElement.addEventListener("pointerdown",ue),e.domElement.addEventListener("pointercancel",he),e.domElement.addEventListener("wheel",de,{passive:!1}),this.update()}}class Oe{constructor(n,o){this.animation=n,this.currentEffectIndex=0,this.tickingEffects=[],this.effects=Object.entries(o).map(([e,s])=>[Number(e),Array.isArray(s)?s:[s]]).sort(([e],[s])=>e-s)}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const n=this.effects[this.currentEffectIndex];if(!(n[0]>this.animation.roundedCurrentTime))return this.currentEffectIndex++,n[1]}reset(){this.currentEffectIndex=0}}class mt extends Oe{tick(){var n;const o=(n=super.getCurrentEffects())!=null?n:[];o.length>0&&console.log(`Playing sound effects: "${o.map(e=>e.effect).join(", ")}"`)}}class ft extends Oe{constructor(){super(...arguments);this.disposables=[]}tick(){var n;this.tickingEffects.forEach(e=>e.tick());const o=(n=super.getCurrentEffects())!=null?n:[];for(const{locator:e,effect:s,pre_effect_script:i}of o){if(!s)return;const p=this.animation.getAnimator(),a=p.getModel(),l=p.getEmitter(s);if(!l||!p.winterskyScene)return;const c=e?a.getLocator(e):void 0,h=new it.Emitter(p.winterskyScene,l,{parent_mode:c?"locator":"entity",loop_mode:"once"});c&&(c.add(h.local_space),h.local_space.parent=c);const f={tick:()=>{h.tick(),h.enabled||(h.delete(),this.tickingEffects=this.tickingEffects.filter(m=>m!==f))}};this.tickingEffects.push(f),this.disposables.push({dispose:()=>{h.delete(),this.tickingEffects=this.tickingEffects.filter(m=>m!==f)}}),h.start(),h.tick()}}dispose(){this.disposables.forEach(n=>n.dispose()),this.disposables=[]}}class gt{constructor(n,o){var e,s;this.animator=n,this.animationData=o,this.startTimestamp=0,this.lastFrameTimestamp=0,this.isRunning=!1,this.env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime},this.molang=new st(this.env,{convertUndefined:!0}),this.soundEffects=new mt(this,(e=this.animationData.sound_effects)!=null?e:{}),this.particleEffects=new ft(this,(s=this.animationData.particle_effects)!=null?s:{})}getAnimator(){return this.animator}execute(n){return this.molang.executeAndCatch(n)}parseBoneModifier(n){if(typeof n=="number")return[n,n,n];if(typeof n=="string"){const o=typeof n=="string"?this.execute(n):n;return[o,o,o]}else{if(Array.isArray(n))return n.map(o=>typeof o=="string"?this.execute(o):o);if(n!==void 0){const o=Object.entries(n).map(([e,s])=>[Number(e),s]).sort(([e],[s])=>e-s);for(let e=o.length-1;e>=0;e--){let[s,i]=o[e];if(!(s>this.currentTime))if(s===this.currentTime){if(Array.isArray(i))return i.map(p=>typeof p=="string"?this.execute(p):p);throw new Error("Format not supported yet")}else{let[p,a]=o[U.euclideanModulo(e+1,o.length)],l=p-s;if(Array.isArray(i)&&Array.isArray(a))return i=i.map(c=>typeof c=="string"?this.execute(c):c),a=a.map(c=>typeof c=="string"?this.execute(c):c),i.map((c,h)=>c+(a[h]-c)/l*(this.currentTime-s));throw new Error("Format not supported yet")}}return[0,0,0]}}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const n=this.animator.getModel().getBoneMap();for(let o in this.animationData.bones){const e=n.get(o);if(!e)continue;const{position:s,rotation:i,scale:p}=this.animationData.bones[o],[a,l,c]=[s,i,p].map(h=>this.parseBoneModifier(h));if(a){const h=e.position.toArray();e.position.set(...a.map((f,m)=>(m===0?-1:1)*f+h[m]))}if(l){const h=e.rotation.toArray();e.rotation.set(...l.map(f=>U.degToRad(f)).map((f,m)=>h[m]+(m===2?f:-f)))}c&&e.scale.set(...c)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class bt{constructor(n){this.model=n,this.animations=new Map,this.particleEmitters=new Map}setupDefaultBonePoses(){for(let n of this.model.getBoneMap().values())n.userData.defaultRotation=n.rotation.toArray(),n.userData.defaultPosition=n.position.toArray()}dispose(){this.disposeAnimations();for(let n of this.model.getBoneMap().values())delete n.userData.defaultRotation,delete n.userData.defaultPosition}disposeAnimations(){this.animations.forEach(n=>n.dispose())}setupWintersky(n){this.winterskyScene=n}addAnimation(n,o){this.animations.set(n,new gt(this,o))}addEmitter(n,o){this.particleEmitters.set(n,o)}getEmitter(n){return this.particleEmitters.get(n)}play(n){const o=this.animations.get(n);if(!o)throw new Error(`Unknown animation: "${n}"`);o.play()}pause(n){const o=this.animations.get(n);if(!o)throw new Error(`Unknown animation: "${n}"`);o.pause()}pauseAll(){for(const n of this.animations.values())n.pause()}tick(){for(let n of this.model.getBoneMap().values())n.rotation.set(...n.userData.defaultRotation),n.position.set(...n.userData.defaultPosition);this.animations.forEach(n=>n.shouldTick&&n.tick())}get shouldTick(){return[...this.animations.values()].some(n=>n.shouldTick)}getModel(){return this.model}}const yt=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}],J=.03;class wt{constructor(n){var o,e,s;this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new Ae,this.group=new X;const{textureSize:[i,p],textureDiscrepancyFactor:[a,l],mirror:c,width:h,height:f,depth:m}=n,[d,A]=[i*a,p*l],v=(o=n.startUV)!=null?o:[0,0],w=!Array.isArray(v);let x=0,O=0;w||([x,O]=v);for(let{name:T,dir:R,corners:u,baseUV:[k,g]}of yt){const y=this.positions.length/3;let b,P;if(w){if(v[T]===void 0)continue;[x,O]=((e=v[T])==null?void 0:e.uv)||[],[b,P]=((s=v[T])==null?void 0:s.uv_size)||[],b*=a,P*=l,x*=a,O*=l,k=0,g=0}for(const{pos:[Y,F,L],uv:S}of u)this.positions.push((c?-Y:Y)*h,F*f,L*m),this.normals.push(...R),this.uvs.push((x+(Number(k>0)+Number(k>2))*Math.floor(b!=null?b:m)+Number(k>1)*Math.floor(b!=null?b:h)+S[0]*Math.floor(T==="west"||T==="east"?b!=null?b:m:b!=null?b:h)+(S[0]===0?J:-J))/(d/(w?1:a)),1-(O+g*Math.floor(P!=null?P:m)+Math.floor(T==="up"||T==="down"?P!=null?P:m:P!=null?P:f)-S[1]*Math.floor(T==="up"||T==="down"?P!=null?P:m:P!=null?P:f)+(S[1]===0?-J:J))/(A/(w?1:l)));this.indices.push(y,y+1,y+2,y+2,y+1,y+3)}this.createGeometry(),this.createMesh(n)}createGeometry(){this.geometry.setAttribute("position",new Z(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new Z(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new Z(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:n,width:o,height:e,depth:s,pivot:i,rotation:p,origin:a,inflate:l=0}){const c=l*2+o,h=new xe(this.geometry,n);if(this.group.rotation.order="ZYX",i===void 0&&(i=[c/2,e/2,s/2]),this.group.add(h),p){this.group.position.set(-i[0],i[1],i[2]),h.position.set(-a[0]-c/2+i[0]+l,a[1]-i[1]-l,a[2]-i[2]-l);const[f,m,d]=p;this.group.rotation.set(U.degToRad(-f),U.degToRad(-m),U.degToRad(d))}else this.group.position.set(-a[0]-c/2+l,a[1]-l,a[2]-l);l&&this.group.scale.set(o!==0?1+l/(o/2):1,e!==0?1+l/(e/2):1,s!==0?1+l/(s/2):1)}getGroup(){return this.group}}class Et{constructor(n){var o,e,s,i,p,a,l;if(this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new Ae,this.group=new X,!Array.isArray(n.polys))throw new Error("Format not supported yet!");n.normalized_uvs||(n.uvs=(o=n==null?void 0:n.uvs)==null?void 0:o.map(([h,f])=>[h/n.textureSize[0],f/n.textureSize[1]]));let c=0;for(const h of n.polys){for(const[f,m,d]of h)this.positions.push(...(s=(e=n==null?void 0:n.positions)==null?void 0:e[f])!=null?s:[]),this.normals.push(...(p=(i=n==null?void 0:n.normals)==null?void 0:i[m])!=null?p:[]),this.uvs.push(...(l=(a=n==null?void 0:n.uvs)==null?void 0:a[d])!=null?l:[]);h.length===3?this.indices.push(c,c+1,c+2):this.indices.push(c+2,c+1,c,c+2,c,c+3),c+=h.length}this.createGeometry(),this.createMesh(n)}createGeometry(){this.geometry.setAttribute("position",new Z(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new Z(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new Z(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:n}){const o=new xe(this.geometry,n);this.group.add(o)}getGroup(){return this.group}}class vt{constructor(n,o){var e,s;this.modelData=n,this.texturePath=o,this.boneMap=new Map,this.locators=new Map,this.animator=new bt(this);const i=(s=(e=n==null?void 0:n.description)==null?void 0:e.identifier)!=null?s:"geometry.unknown";this.model=new X,this.model.name=i}async create(){var n,o,e,s,i,p;const a=this.modelData,l=await this.loadTexture(this.texturePath),c=[(o=(n=a==null?void 0:a.description)==null?void 0:n.texture_width)!=null?o:l.image.width,(s=(e=a==null?void 0:a.description)==null?void 0:e.texture_height)!=null?s:l.image.height],h=[l.image.width/c[0],l.image.height/c[1]],f=new Map;l.magFilter=ye,l.minFilter=ye;const m=new He({side:we,alphaTest:.2,transparent:!0,map:l});(i=a==null?void 0:a.bones)==null||i.forEach(d=>{var A,v,w,x,O,T;const R=new X;if(R.name=(A=d.name)!=null?A:"unknown",d.poly_mesh){const g=new Et(dt(ht({},d.poly_mesh),{textureSize:c,material:m,mirror:(v=d.mirror)!=null?v:!1,origin:[0,0,0],inflate:d.inflate,rotation:[0,0,0],pivot:d.pivot})).getGroup();g.name=`#bone.${d.name}#polyMesh`,R.add(g)}(w=d.cubes)==null||w.forEach((g,y)=>{var b,P,Y,F,L,S,B,V,W,q,K;const $=new wt({width:(P=(b=g.size)==null?void 0:b[0])!=null?P:0,height:(F=(Y=g.size)==null?void 0:Y[1])!=null?F:0,depth:(S=(L=g.size)==null?void 0:L[2])!=null?S:0,startUV:g.uv,textureSize:c,textureDiscrepancyFactor:h,material:m,mirror:g.mirror===void 0&&g.rotation===void 0?(B=d.mirror)!=null?B:!1:(V=g.mirror)!=null?V:!1,origin:(W=g.origin)!=null?W:[0,0,0],inflate:(q=g.inflate)!=null?q:d.inflate,rotation:g.rotation,pivot:(K=g.pivot)!=null?K:d.pivot}).getGroup();$.name=`#bone.${d.name}#cube.${y}`,R.add($)});const u=new X;if(u.rotation.order="ZYX",d.pivot){const[g,y,b]=d.pivot;u.position.set(-g,y,b),R.position.set(g,-y,-b)}else u.position.set(0,0,0);if(u.add(R),u.name=`#pivot.${d.name}`,d.rotation){const[g,y,b]=d.rotation;u.rotation.set(U.degToRad(-g),U.degToRad(-y),U.degToRad(b))}const k=(x=d.locators)!=null?x:{};for(const g in k){const y=new X;y.name=`locator#${g}`;const b=k[g];Array.isArray(b)?y.position.set(...b):typeof b=="object"&&(y.position.set(...(O=b.offset)!=null?O:[0,0,0]),y.rotation.set(...(T=b.rotation)!=null?T:[0,0,0])),this.locators.set(g,y),u.add(y)}d.parent||this.model.add(u),d.name&&(f.set(d.name,[d.parent,u]),this.boneMap.set(d.name,u))});for(let[d,[A,v]]of f)if(A){const w=(p=f.get(A))==null?void 0:p[1];w&&w.name.startsWith("#pivot.")?w.children[0].add(v):w&&w.add(v)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(n){return this.locators.get(n)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(n,o,e){const s=new Ce({side:we,color:n,linewidth:20}),i=new Ge(e.x,e.y,e.z),p=new Xe(i),a=new Ze(p,s);return a.position.set(o.x,o.y+e.y/2,o.z),a.name="helperBox",this.model.add(a),{dispose:()=>{this.model.remove(a)}}}hideBone(n){const o=this.boneMap.get(n);o&&(o.visible=!1)}showBone(n){const o=this.boneMap.get(n);o&&(o.visible=!0)}get bones(){return[...this.boneMap.keys()]}dispose(){this.animator.dispose()}loadTexture(n){return new Promise((o,e)=>{new Be().load(n,i=>{o(i)})})}}class Mt{constructor(n,o,e,s){var i;this.canvasElement=n,this.texturePath=e,this.options=s,this.renderingRequested=!1,this.renderer=new Ve({canvas:n,antialias:(i=s.antialias)!=null?i:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new qe(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new pt(this.camera,n),this.scene=new We,this.scene.add(new Ke(16777215)),this.scene.background=new $e(13299960),this.model=new vt(o,e),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",()=>this.requestRendering()),this.onResize(),this.loadedModel=this.loadModel().then(()=>this.requestRendering())}async loadModel(){await this.model.create()}get width(){var n;return(n=this.options.width)!=null?n:window.innerWidth}get height(){var n;return(n=this.options.height)!=null?n:window.innerHeight}render(n=!0){var o;this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,n&&this.model.shouldTick&&(this.model.tick(),(o=this.model.animator.winterskyScene)==null||o.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(n=!1){if(n)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame(()=>this.render()))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new Qe(50)),this.scene.add(new Je(20,20)),this.scene.add(new et(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(n=1.5,o=!0){o&&this.model.getGroup().rotation.set(0,Math.PI,0);const e=new tt().setFromObject(this.model.getGroup()).getBoundingSphere(new nt),s=this.camera.fov*Math.PI/180*n,i=e.radius/Math.tan(s/2),p=Math.sqrt(Math.pow(i,2)+Math.pow(i,2));this.camera.position.set(p,p,p),this.controls.update(),this.camera.lookAt(e.center),this.controls.target.set(e.center.x,e.center.y,e.center.z),this.camera.updateProjectionMatrix()}}export{vt as Model,Mt as StandaloneModelViewer};
